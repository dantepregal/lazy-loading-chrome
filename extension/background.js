// Generated by CoffeeScript 1.5.0-pre
(function() {
  var block, no_blocked, park, parkTab, urlBlank;

  urlBlank = 'https://lazy-loading-chrome.googlecode.com/git/server/blank.html';

  parkTab = function(tab) {
    var url;
    if (!tab.active) {
      if (tab.url.substring(0, tab.url.indexOf('#')) !== urlBlank) {
        url = urlBlank + '#title=' + encodeURIComponent(tab.title);
        if (tab.favIconUrl) {
          url += '&icon=' + encodeURIComponent(tab.favIconUrl);
        }
        return chrome.tabs.update(tab.id, {
          'url': url,
          'selected': false
        });
      }
    }
  };

  block = function(details) {
    return {
      cancel: true
    };
  };

  no_blocked = true;

  park = function(tab) {
    if (no_blocked) {
      chrome.webRequest.onBeforeRequest.addListener(block, {
        urls: [urlBlank + '*']
      }, ["blocking"]);
      no_blocked = false;
    }
    return chrome.windows.get(tab.windowId, {
      populate: true
    }, function(window) {
      var t, _i, _len, _ref;
      _ref = window.tabs;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        t = _ref[_i];
        parkTab(t);
      }
      return setTimeout(chrome.windows.remove, 1000, tab.windowId);
    });
  };

  chrome.browserAction.onClicked.addListener(park);

  chrome.tabs.onActivated.addListener(function(activeInfo) {
    return chrome.tabs.sendMessage(activeInfo.tabId, {
      'do': 'load'
    }, function() {});
  });

}).call(this);
